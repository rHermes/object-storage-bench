version: v1.0
name: Go
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

# global_job_config:
#   env_vars:
#     - name: PATH
#       value: /home/semaphore/go/bin:$PATH

blocks:
  - name: Download deps
    task:
      prologue:
        commands:
          - echo "$PATH"
          - checkout --use-cache
          - cache restore
          - sem-version go 1.16.3
      jobs:
        - name: download deps
          commands:
            - go install gotest.tools/gotestsum@v1.7.0
            - go get ./...

  - name: Test things
    task:
      jobs:
        - name: go test
          commands:
            - gotestsum --junitfile /tmp/junit.xml ./...
      prologue:
        commands:
          - checkout --use-cache
          - cache restore
          - sem-version go 1.16.3
      epilogue:
        always:
          commands:
            - cache store
            - test-results publish /tmp/junit.xml

